// we put a reasonable 200 character limit, to be extra sure of no buffer overflows

sar_on_cfg_message __cfg_msg_handle
sar_function cfg_msg_test "svar_set _sar_cfg_message $'$1$'; __cfg_msg_handle"
sar_function __cfg_msg_handle "svar_substr _sar_cfg_message 0 200; sar_expand index_of $'$$_sar_cfg_message$' :; conds ?index_of_ret=-1|?index_of_ret=0 __cfg_msg_handle_invalid __cfg_msg_handle_h2"
sar_function __cfg_msg_handle_invalid sar_echo eecc44 Malformed CFG message: "$_sar_cfg_message"
sar_function __cfg_msg_handle_h2 "svar_set __cfg_msg_type $'$_sar_cfg_message$'; svar_set __cfg_msg_msg $'$_sar_cfg_message$'; __cfg_msg_handle_h3"
sar_function __cfg_msg_handle_h3 "svar_substr __cfg_msg_type 0 $index_of_ret; svar_add index_of_ret 1; sar_expand svar_substr __cfg_msg_msg $$index_of_ret; svar_set __cfg_msg_i 0; svar_set __cfg_msg_handled 0; __cfg_msg_handle_h4"
sar_function __cfg_msg_handle_h4 conds ?__cfg_msg_i=?__cfg_msg_handlers_len "cond !?__cfg_msg_handled=1 sar_echo eecc44 Unknown CFG message type $__cfg_msg_type" "cond ?__cfg_msg_handlers_n$__cfg_msg_i=?__cfg_msg_type __cfg_msg_handle_h5; svar_add __cfg_msg_i 1; __cfg_msg_handle_h4"
sar_function __cfg_msg_handle_h5 "sar_expand $$__cfg_msg_handlers_c$__cfg_msg_i; svar_set __cfg_msg_handled 1"

svar_set __cfg_msg_handlers_len 0
sar_function cfg_msg_handler_add "svar_add __cfg_msg_handlers_len 1; svar_set __cfg_msg_handlers_n$__cfg_msg_handlers_len $1; svar_set __cfg_msg_handlers_c$__cfg_msg_handlers_len $2"

sar_function __cfg_msg_handler_cmd conds ?__partner_trust_$partner=1 "echo CFG command $__cfg_msg_msg; $__cfg_msg_msg" "sar_echo eecc44 Untrusted partner $partner tried to send command $__cfg_msg_msg"
cfg_msg_handler_add "cmd" "__cfg_msg_handler_cmd"
