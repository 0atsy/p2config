exec platform
exec util
exec extra_viewsnaps

// Personal Commands
sar_on_config_exec hwait 30 "sensitivity 0.39"
fps_max 360
sar_force_fov 100
sar_discord_rpc_enabled 1
svar_set cm_hud_behavior -1

cond "game=portal2|game=srm|game=mel" +fullbright
sar_alias thignaign fullbright_toggle_brightness

svar_set fullbright_amount_high 0.07
svar_set fullbright_amount_low 0.004
cond "game=mel" svar_set fullbright_amount_low 0.01
sar_function fullbright_toggle_brightness "conds ?fullbright_amount=?fullbright_amount_high fullbright_low fullbright_high; fullbright_toggle; fullbright_toggle"
sar_function fullbright_high "svar_set fullbright_amount $fullbright_amount_high"
sar_function fullbright_low  "svar_set fullbright_amount $fullbright_amount_low"

exec crazy
exec con_filter

sar_alias c "map sp_a3_crazy_box"
sar_alias q "quit"
sar_alias angles "exec angles"
sar_alias nohud "exec nohud"
sar_alias ihud "sar_ihud 1"
sar_alias ihudoff "sar_ihud 0"
sar_alias strafe "exec strafehud"


sar_function +nanjump "m_customaccel 1; m_customaccel_exponent 9e99; +strafe $1"
sar_function -nanjump "m_customaccel 0; m_customaccel_exponent 1.3; -strafe $1"

sar_speedrun_skip_cutscenes 1

// sar_ihud
sar_ihud 1
sar_ihud_grid_size 55
sar_ihud_setpos bottom left
sar_ihud_modify all highlight=6ba4b8

// hud
sar_hud_font_index 24
sar_hud_order_bottom groundframes
sar_hud_order_top text
sar_hud_order_top demo
sar_hud_bg 0
sar_hud_groundframes 1
sar_hud_demo 0
sar_hud_x 10
sar_hud_y 100
sar_hud_show_text 0
sar_hud_velocity 4
sar_hud_precision 2
sar_transition_timer 1

// toasts
sar_toast_tag_set_duration speedrun 3
sar_toast_anchor 0
sar_toast_font 62
sar_toast_align 0
sar_toast_setpos bottom left
sar_toast_x 23
sar_toast_y 1210

// Quickzoom
sar_alias __senschoose  conds "?lowsens=0 & ?quickzoom=0" "-customsens" "__senschoose1"
sar_alias __senschoose1 conds "?lowsens=0 & ?quickzoom=1" "+customsens 0.06" "__senschoose2"
sar_alias __senschoose2 conds "?lowsens=1 & ?quickzoom=0" "+customsens 0.01" "+customsens 0.002"

sar_function +lowsens "svar_set lowsens 1; __senschoose; sar_alias lowsens_toggle -lowsens"
sar_function -lowsens "svar_set lowsens 0; __senschoose; sar_alias lowsens_toggle +lowsens"
-lowsens

sar_alias +quickzoom "sar_force_fov 45;  svar_set quickzoom 1; __senschoose; viewmodel_offset_x 10000; sar_alias quickzoom_toggle -quickzoom"
sar_alias -quickzoom "sar_force_fov 100; svar_set quickzoom 0; __senschoose; viewmodel_offset_x 0; sar_alias quickzoom_toggle +quickzoom"
-quickzoom

// Toggle sprint
sar_alias __+togglesprint "+speed; sar_alias togglesprint __-togglesprint"
sar_alias __-togglesprint "-speed; sar_alias togglesprint __+togglesprint"
sar_alias togglesprint "__+togglesprint"

// Portal colors
sar_portalcolor_enable 1
sar_portalcolor_mp1_1 "80 120 255"
sar_portalcolor_mp1_2 "100 64 220"
sar_portalcolor_mp2_1 "255 51 255"
sar_portalcolor_mp2_2 "51 0 102"
sar_on_load conds coop "sar_portalcolor_sp_1 80 120 255" "sar_portalcolor_sp_1 20 160 255"
sar_on_load conds coop "sar_portalcolor_sp_2 255 51 255" "sar_portalcolor_sp_2 255 51 255"

sar_function partner_add_replace "svar_set __partner_name $'$2$'; svar_set __partner_id $1; __partner_add 1"
sar_function __partner_persist_trust "sar_expand svar_persist __partner_trust_$$$1"
sar_function partner_trust "svar_set __partner_trust_$1 1; svar_persist __partner_trust_$1"
sar_function partner_untrust "svar_set __partner_trust_$1 0; svar_persist __partner_trust_$1"
__partner_loop __partner_persist
__partner_loop __partner_persist_trust

sar_function __cfg_msg_handler_cmd conds ?__partner_trust_$partner=1 "echo CFG command $__cfg_msg_msg; $__cfg_msg_msg" "sar_echo eecc44 Untrusted partner $partner tried to send command $__cfg_msg_msg"
cfg_msg_handler_add "cmd" "__cfg_msg_handler_cmd"

// ghosts
ghost_set_color 6ba4b8
-ghost_leaderboard
ghost_leaderboard_y 330
ghost_proximity_fade 300
ghost_show_advancement 2
ghost_list_show_map 1
ghost_list_font 24

// extra chapter runs
add_cat "relay1"
sar_speedrun_cc_start "relay1"
sar_speedrun_cc_rule "Container Start" entity map=sp_a1_intro1 action=start targetname=camera_intro inputname=TeleportToView
sar_speedrun_cc_rule "Vault Start" entity map=sp_a1_intro1 action=start targetname=camera_1 inputname=TeleportPlayerToProxy
sar_speedrun_cc_rule "Vault Save Start" entity map=sp_a1_intro1 action=start targetname=@glados inputname=RunScriptCode "parameter=GladosRelaxationVaultPowerUp()"
sar_speedrun_cc_rule "End" end map=sp_a2_pull_the_rug action=stop
sar_speedrun_cc_finish

add_cat "relay2"
sar_speedrun_cc_start "relay2"
sar_speedrun_cc_rule "Start" load map=sp_a2_column_blocker action=start
sar_speedrun_cc_rule "End" end map=sp_a2_core action=stop
sar_speedrun_cc_finish

add_cat "relay3"
sar_speedrun_cc_start "relay3"
sar_speedrun_cc_rule "Cutscene Start" load map=sp_a3_00 action=start
sar_speedrun_cc_rule "Start" load map=sp_a3_01 action=start
sar_speedrun_cc_rule "End" end map=sp_a3_end action=stop
sar_speedrun_cc_finish

add_cat "relay4"
sar_speedrun_cc_start "relay4"
sar_speedrun_cc_rule "Start" load map=sp_a4_intro action=start
sar_speedrun_cc_rule "End" entity map=sp_a4_finale4 action=stop targetname=@glados inputname=RunScriptCode "parameter=BBPortalPlaced()"
sar_speedrun_cc_finish

add_cat divinity
add_cat p1dp2

// segmented
add_cat seggy
sar_alias cm_only     cond   "?category=sp_cm | ?category=coop_cm | ?category=seggy"
sar_alias non_cm_only cond "!(?category=sp_cm | ?category=coop_cm | ?category=seggy)"

// mel
cond "game=mel" sar_prevent_ehm 0
cond "game=mel" sar_loads_uncap 0
cond "game=mel" dialogue_toggle
cond "game=mel" sar_speedrun_time_pauses 0
cond "map=st_a2_ramp" sar_speedrun_time_pauses 1

cond "game=mel" sar_on_load conds "?map=destroyed-garden" "sar_fast_load_preset normal" "sar_fast_load_preset full"
cond "game=mel" sar_on_load cond  "?map=destroyed-garden" "cond !same_map svar_set loads 0; svar_add loads 1; sar_expand sar_toast_create loads $loads Loads"

cond "game=mel" sar_ihud_add_key v
cond "game=mel" sar_ihud_add_key q
cond "game=mel" sar_ihud_add_key ralt
cond "game=mel" sar_ihud_add_key f
cond "game=mel" sar_ihud_modify v text=SLA x=4 y=1
cond "game=mel" sar_ihud_modify f text=Sens x=5 y=1
cond "game=mel" sar_ihud_modify q text=Slow x=1 y=0
cond "game=mel" sar_ihud_modify ralt text=Slow x=1 y=0 background=00000000
cond "game=mel" sar_ihud_modify all font=24 highlight=6ba4b8

cond "game=mel" sar_sr_hud 2
cond "game=mel" sar_sr_hud_font_index 38
cond "game=mel" sar_sr_hud_font_index_2 32
cond "game=mel" sar_sr_hud_font_color 0 255 0
cond "game=mel" sar_sr_hud_y 1265
cond "game=mel" sar_sr_hud_x 240

// infra
sar_toast_tag_set_duration lineup forever
sar_on_load sar_toast_tag_dismiss_all lineup
sar_on_load cond "game=infra" sar_toast_tag_dismiss_all fade // remove default toasts
sar_on_load cond "game=infra" exec lineups/infra

cond "game=infra" +speed
cond "game=infra" infra_transition_fade_in_time 0
cond "game=infra" infra_transition_fade_in_hold_time 0
cond "game=infra" infra_transition_fade_out_time 0
cond "game=infra" infra_transition_fade_out_hold_time 0
// cond "game=infra" sar_on_load "snd_restart"

cond "game=infra" sar_on_load cat_only fullgame sar_alias do_reset "sar_speedrun_reset; stop; load start"

cond "game=infra" sar_ihud_add_key mouse4
cond "game=infra" sar_ihud_add_key r
cond "game=infra" sar_ihud_add_key v
cond "game=infra" sar_ihud_modify mouse4 text=Save x=4 y=1
cond "game=infra" sar_ihud_modify v text=SLA x=4 y=0
cond "game=infra" sar_ihud_modify r text=Load x=5 y=1
cond "game=infra" sar_ihud_modify all font=28 highlight=6ba4b8

cond "game=infra" sar_hud_font_index 82
cond "game=infra" sar_hud_velocity 3
cond "game=infra" sar_toast_font 82
cond "game=infra" ghost_proximity_fade 140
cond "game=infra" sar_sr_hud 2
cond "game=infra" sar_sr_hud_font_index_2 70
cond "game=infra" sar_sr_hud_font_color 0 255 0
cond "game=infra" sar_sr_hud_y 1270
cond "game=infra" sar_sr_hud_x 5
